{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "dataFactoryLocation": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "minLength": 3,
            "maxLength": 11,
            "metadata": {
                "description": "data factory location"
            }
        },

        "wpaAppDataFactoryName": {
            "type": "string",
            "defaultValue": "wpadatafeed",
            "minLength": 3,
            "maxLength": 25,
            "metadata": {
                "description": "data factory name"
            }
        },
        "copyToBlobStorageMode": {
            "type": "string",
            "defaultValue": "all",
            "minLength": 3,
            "maxLength": 11,
            "metadata": {
                "description": "what data to copy"
            }
        },
        "wpaSourceODataFeedQuery": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "odata uery"
            }
        },

        "wpaReaderAppId": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Azure AD APP Id"
            }
        },
        "wpaSourceODataFeedUrl": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "endpoint url"
            }
        },

        "wpaKeyVaultName": {
            "type": "string",
            "metadata": {
                "description": "Specifies the name of the vault to be created."
            }
        },
        "wpaReaderAppSecretName": {
            "type": "string",
            "defaultValue": "Sample",
            "metadata": {
                "description": "Specifies the secret name to be used in the vault for the OData reader app"
            }
        },
        "wpaReaderAppSecretValue": {
            "type": "string",
            "defaultValue": "Sample",
            "metadata": {
                "description": "Specifies the secret value to be used in the vault for the OData reader app"
            }
        },
        "appServicePrincipalId": {
            "type": "string",
            "metadata": {
                "description": "App service principal Id"
            }
        },


        "wpaStorageContainerName": {
            "type": "string",
            "defaultValue": "wpaexports",
            "metadata": {
                "description": "Specifies the name of the blob container to which the wpa feed to be exported."
            }
        },
        "wpaAppStorageAccType": {
            "type": "string",
            "defaultValue": "Standard_LRS",
            "allowedValues": [
                "Standard_LRS",
                "Standard_GRS",
                "Standard_ZRS",
                "Premium_LRS"
            ],
            "metadata": {
                "description": "Storage Account type"
            }
        },
        "wpaAppStorageAccNamePrefix": {
            "type": "string",
            "defaultValue": "storage",
            "minLength": 3,
            "maxLength": 25,
            "metadata": {
                "description": "Prefix for the Storage Acc name to be combined with the unique string"
            }
        }
    },
    "variables": {
        "factoryId": "[concat('Microsoft.DataFactory/factories/', parameters('wpaAppDataFactoryName'),uniqueString(resourceGroup().id))]",
        "factoryName":  "[concat(parameters('wpaAppDataFactoryName'), uniqueString(resourceGroup().id))]",
        "storageAccName": "[concat(parameters('wpaAppStorageAccNamePrefix'), uniqueString(resourceGroup().id))]"


    },
    "resources": [

        {

            "name":"[variables('factoryName')]",
            "apiVersion":"2018-06-01",
            "type":"Microsoft.DataFactory/factories",
            "location":"[parameters('dataFactoryLocation')]",
            "identity":{"type":"SystemAssigned" },
            "resources":[
                {
                    "name": "[concat(variables('factoryName'), '/CopyPipeline')]",
                    "type": "Microsoft.DataFactory/factories/pipelines",
                    "apiVersion": "2018-06-01",
                    "properties": {

                    "activities": [
                        {
                            "name": "CopyDataToBlob",
                            "type": "Copy",
                            "dependsOn": [],
                            "policy": {
                                "timeout": "7.00:00:00",
                                "retry": 0,
                                "retryIntervalInSeconds": 30,
                                "secureOutput": false,
                                "secureInput": false
                            },
                            "userProperties": [],
                            "typeProperties": {
                                "source": {
                                    "type": "ODataSource",
                                    "httpRequestTimeout": "00:05:00"
                                },
                                "sink": {
                                    "type": "DelimitedTextSink",
                                    "storeSettings": {
                                        "type": "AzureBlobStorageWriteSettings"
                                    },
                                    "formatSettings": {
                                        "type": "DelimitedTextWriteSettings",
                                        "quoteAllText": true,
                                        "fileExtension": ".txt"
                                    }
                                },
                                "enableStaging": false
                            },
                            "inputs": [
                                {
                                    "referenceName": "WPAODataDS",
                                    "type": "DatasetReference",
                                    "parameters": {}
                                }
                            ],
                            "outputs": [
                                {
                                    "referenceName": "DelimitedTextDS",
                                    "type": "DatasetReference",
                                    "parameters": {}
                                }
                            ]
                        }
                    ],

                        "annotations": []
                    },
                    "dependsOn": [

                        "[variables('factoryName')]",
                        "[concat(variables('factoryId'), '/datasets/WPAODataDS')]",
                        "[concat(variables('factoryId'), '/datasets/DelimitedTextDS')]"
                    ]
                },

            {
                "name": "[concat(variables('factoryName'), '/WPAODataLS')]",
                "type": "Microsoft.DataFactory/factories/linkedServices",
                "apiVersion": "2018-06-01",
                "properties": {
                    "annotations": [],
                    "type": "OData",
                    "typeProperties": {
                        "url": "[parameters('wpaSourceODataFeedUrl')]",
                        "authenticationType": "AadServicePrincipal",
                        "tenant": "[subscription().tenantId]",
                        "aadResourceId": "https://workplaceanalytics.office.com",
                        "aadServicePrincipalCredentialType": "ServicePrincipalKey",
                        "servicePrincipalId": "[parameters('wpaReaderAppId')]",
                        "servicePrincipalKey": {
                            "type": "AzureKeyVaultSecret",
                            "store": {
                                "referenceName": "AzureKeyVaultLS",
                                "type": "LinkedServiceReference"
                            },
                            "secretName": "DataReaderClientSecret"
                        }
                    }
                },
                "dependsOn": [
                    "[variables('factoryName')]",
                    "[concat(variables('factoryId'), '/linkedServices/AzureKeyVaultLS')]"
                ]
            },
            {
                "name": "[concat(variables('factoryName'), '/AzureKeyVaultLS')]",
                "type": "Microsoft.DataFactory/factories/linkedServices",
                "apiVersion": "2018-06-01",
                "properties": {
                    "annotations": [],
                    "type": "AzureKeyVault",
                    "typeProperties": {
                        "baseUrl": "[concat('https://',parameters('wpaKeyVaultName'), '.vault.azure.net/')]"
                    }
                },

                "dependsOn": [
                    "[variables('factoryName')]"
                ]
            },
            {
                "name": "[concat(variables('factoryName'), '/WPAODataDS')]",
                "type": "Microsoft.DataFactory/factories/datasets",
                "apiVersion": "2018-06-01",
                "properties": {
                    "linkedServiceName": {
                        "referenceName": "WPAODataLS",
                        "type": "LinkedServiceReference"
                    },
                    "annotations": [],
                    "type": "ODataResource",
                    "schema": [],
                    "typeProperties": {
                        "path": "Persons"
                    }
                },
                "dependsOn": [
                    "[variables('factoryName')]",
                    "[concat(variables('factoryId'), '/linkedServices/WPAODataLS')]"
                ]
            },
            {
                "name": "[concat(variables('factoryName'), '/AzureBlobStorageLS')]",
                "type": "Microsoft.DataFactory/factories/linkedServices",
                "apiVersion": "2018-06-01",
                "properties": {
                    "annotations": [],
                    "type": "AzureBlobStorage",
                    "typeProperties": {
                        "serviceEndpoint": "[concat('https://',variables('storageAccName'), '.blob.core.windows.net')]",

                        "servicePrincipalId": "[parameters('wpaReaderAppId')]",
                        "tenant": "[subscription().tenantId]",
                        "servicePrincipalKey": {
                            "type": "AzureKeyVaultSecret",
                            "store": {
                                "referenceName": "AzureKeyVaultLS",
                                "type": "LinkedServiceReference"
                            },
                            "secretName": "[parameters('wpaReaderAppSecretName')]",
                            "secretVersion": ""
                        }
                    }
                },
                "dependsOn": [
                    "[variables('factoryId')]",
                    "[concat(variables('factoryId'), '/linkedServices/AzureKeyVaultLS')]"
                ]
            }
            ]

        },



        {
            "type": "Microsoft.KeyVault/vaults/accessPolicies",
            "name": "[concat(parameters('wpaKeyVaultName'), '/add')]",

            "apiVersion": "2019-09-01",
            "dependsOn": [ "[variables('factoryName')]"
            ],
            "properties": {
              "accessPolicies": [
                {
                    "objectId": "[reference(resourceId('Microsoft.DataFactory/factories/', variables('factoryName')),'2018-06-01', 'Full').identity.principalId]",
                    "tenantId": "[subscription().tenantId]",
                    "permissions": {
                        "keys": [
                            "Get",
                            "List",
                            "Update",
                            "Create",
                            "Import",
                            "Delete",
                            "Recover",
                            "Backup",
                            "Restore"
                        ],
                        "secrets": [
                            "Get",
                            "List"

                        ],
                        "certificates": [
                            "Get",
                            "List"

                        ]
                    }
                }
              ]
            }
          },
        {
            "type": "Microsoft.KeyVault/vaults",
            "name": "[parameters('wpaKeyVaultName')]",
            "location": "[resourceGroup().location]",
            "apiVersion": "2018-02-14",
            "properties": {
                "sku": {
                    "family": "A",
                    "name": "standard"
                },
                "tenantId": "[subscription().tenantId]",
                "accessPolicies": [
                        {
                            "objectId": "[parameters('appServicePrincipalId')]",
                            "tenantId": "[subscription().tenantId]",
                            "permissions": {
                                "keys": [
                                    "Get"
                                ],
                                "secrets": [
                                    "Get"
                                ],
                                "certificates": []
                            },
                            "applicationId": null
                        }

                    ]
                }

        },
        {
            "type": "Microsoft.KeyVault/vaults/secrets",
            "name":"[concat(parameters('wpaKeyVaultName'),'/', parameters('wpaReaderAppSecretName'))]",
            "apiVersion": "2015-06-01",
            "properties": {
                "contentType": "text/plain",
                "value": "[parameters('wpaReaderAppSecretValue')]"
            },
            "dependsOn": [
                "[parameters('wpaKeyVaultName')]"
            ]
        },
        {
            "name": "[concat(variables('factoryName'), '/DelimitedTextDS')]",
            "type": "Microsoft.DataFactory/factories/datasets",
            "apiVersion": "2018-06-01",
            "properties": {
                "linkedServiceName": {
                    "referenceName": "AzureBlobStorageLS",
                    "type": "LinkedServiceReference"
                },
                "annotations": [],
                "type": "DelimitedText",
                "typeProperties": {
                    "location": {
                        "type": "AzureBlobStorageLocation",
                        "container": "wpaexports"
                    },
                    "columnDelimiter": ",",
                    "escapeChar": "\\",
                    "firstRowAsHeader": true,
                    "quoteChar": "\""
                },
                "schema": [
                    {
                        "name": "PersonId",
                        "type": "String"
                    },
                    {
                        "name": "Date",
                        "type": "String"
                    },
                    {
                        "name": "Unscheduled_calls_23_24",
                        "type": "String"
                    },
                    {
                        "name": "Unscheduled_calls_22_23",
                        "type": "String"
                    },
                    {
                        "name": "Unscheduled_calls_21_22",
                        "type": "String"
                    },
                    {
                        "name": "Unscheduled_calls_20_21",
                        "type": "String"
                    },
                    {
                        "name": "Unscheduled_calls_19_20",
                        "type": "String"
                    },
                    {
                        "name": "Unscheduled_calls_18_19",
                        "type": "String"
                    },
                    {
                        "name": "Unscheduled_calls_17_18",
                        "type": "String"
                    },
                    {
                        "name": "Unscheduled_calls_16_17",
                        "type": "String"
                    },
                    {
                        "name": "Unscheduled_calls_15_16",
                        "type": "String"
                    },
                    {
                        "name": "Unscheduled_calls_14_15",
                        "type": "String"
                    },
                    {
                        "name": "Unscheduled_calls_13_14",
                        "type": "String"
                    },
                    {
                        "name": "Unscheduled_calls_12_13",
                        "type": "String"
                    },
                    {
                        "name": "Unscheduled_calls_11_12",
                        "type": "String"
                    },
                    {
                        "name": "Unscheduled_calls_10_11",
                        "type": "String"
                    },
                    {
                        "name": "Unscheduled_calls_09_10",
                        "type": "String"
                    },
                    {
                        "name": "Unscheduled_calls_08_09",
                        "type": "String"
                    },
                    {
                        "name": "Unscheduled_calls_07_08",
                        "type": "String"
                    },
                    {
                        "name": "Unscheduled_calls_06_07",
                        "type": "String"
                    },
                    {
                        "name": "Unscheduled_calls_05_06",
                        "type": "String"
                    },
                    {
                        "name": "Unscheduled_calls_04_05",
                        "type": "String"
                    },
                    {
                        "name": "Unscheduled_calls_03_04",
                        "type": "String"
                    },
                    {
                        "name": "Unscheduled_calls_02_03",
                        "type": "String"
                    },
                    {
                        "name": "Unscheduled_calls_01_02",
                        "type": "String"
                    },
                    {
                        "name": "Unscheduled_calls_00_01",
                        "type": "String"
                    },
                    {
                        "name": "IMs_sent_23_24",
                        "type": "String"
                    },
                    {
                        "name": "IMs_sent_22_23",
                        "type": "String"
                    },
                    {
                        "name": "IMs_sent_21_22",
                        "type": "String"
                    },
                    {
                        "name": "IMs_sent_20_21",
                        "type": "String"
                    },
                    {
                        "name": "IMs_sent_19_20",
                        "type": "String"
                    },
                    {
                        "name": "IMs_sent_18_19",
                        "type": "String"
                    },
                    {
                        "name": "IMs_sent_17_18",
                        "type": "String"
                    },
                    {
                        "name": "IMs_sent_16_17",
                        "type": "String"
                    },
                    {
                        "name": "IMs_sent_15_16",
                        "type": "String"
                    },
                    {
                        "name": "IMs_sent_14_15",
                        "type": "String"
                    },
                    {
                        "name": "IMs_sent_13_14",
                        "type": "String"
                    },
                    {
                        "name": "IMs_sent_12_13",
                        "type": "String"
                    },
                    {
                        "name": "IMs_sent_11_12",
                        "type": "String"
                    },
                    {
                        "name": "IMs_sent_10_11",
                        "type": "String"
                    },
                    {
                        "name": "IMs_sent_09_10",
                        "type": "String"
                    },
                    {
                        "name": "IMs_sent_08_09",
                        "type": "String"
                    },
                    {
                        "name": "IMs_sent_07_08",
                        "type": "String"
                    },
                    {
                        "name": "IMs_sent_06_07",
                        "type": "String"
                    },
                    {
                        "name": "IMs_sent_05_06",
                        "type": "String"
                    },
                    {
                        "name": "IMs_sent_04_05",
                        "type": "String"
                    },
                    {
                        "name": "IMs_sent_03_04",
                        "type": "String"
                    },
                    {
                        "name": "IMs_sent_02_03",
                        "type": "String"
                    },
                    {
                        "name": "IMs_sent_01_02",
                        "type": "String"
                    },
                    {
                        "name": "IMs_sent_00_01",
                        "type": "String"
                    },
                    {
                        "name": "Emails_sent_23_24",
                        "type": "String"
                    },
                    {
                        "name": "Emails_sent_22_23",
                        "type": "String"
                    },
                    {
                        "name": "Emails_sent_21_22",
                        "type": "String"
                    },
                    {
                        "name": "Emails_sent_20_21",
                        "type": "String"
                    },
                    {
                        "name": "Emails_sent_19_20",
                        "type": "String"
                    },
                    {
                        "name": "Emails_sent_18_19",
                        "type": "String"
                    },
                    {
                        "name": "Emails_sent_17_18",
                        "type": "String"
                    },
                    {
                        "name": "Emails_sent_16_17",
                        "type": "String"
                    },
                    {
                        "name": "Emails_sent_15_16",
                        "type": "String"
                    },
                    {
                        "name": "Emails_sent_14_15",
                        "type": "String"
                    },
                    {
                        "name": "Emails_sent_13_14",
                        "type": "String"
                    },
                    {
                        "name": "Emails_sent_12_13",
                        "type": "String"
                    },
                    {
                        "name": "Emails_sent_11_12",
                        "type": "String"
                    },
                    {
                        "name": "Emails_sent_10_11",
                        "type": "String"
                    },
                    {
                        "name": "Emails_sent_09_10",
                        "type": "String"
                    },
                    {
                        "name": "Emails_sent_08_09",
                        "type": "String"
                    },
                    {
                        "name": "Emails_sent_07_08",
                        "type": "String"
                    },
                    {
                        "name": "Emails_sent_06_07",
                        "type": "String"
                    },
                    {
                        "name": "Emails_sent_05_06",
                        "type": "String"
                    },
                    {
                        "name": "Emails_sent_04_05",
                        "type": "String"
                    },
                    {
                        "name": "Emails_sent_03_04",
                        "type": "String"
                    },
                    {
                        "name": "Emails_sent_02_03",
                        "type": "String"
                    },
                    {
                        "name": "Emails_sent_01_02",
                        "type": "String"
                    },
                    {
                        "name": "Emails_sent_00_01",
                        "type": "String"
                    },
                    {
                        "name": "Meetings_23_24",
                        "type": "String"
                    },
                    {
                        "name": "Meetings_22_23",
                        "type": "String"
                    },
                    {
                        "name": "Meetings_21_22",
                        "type": "String"
                    },
                    {
                        "name": "Meetings_20_21",
                        "type": "String"
                    },
                    {
                        "name": "Meetings_19_20",
                        "type": "String"
                    },
                    {
                        "name": "Meetings_18_19",
                        "type": "String"
                    },
                    {
                        "name": "Meetings_17_18",
                        "type": "String"
                    },
                    {
                        "name": "Meetings_16_17",
                        "type": "String"
                    },
                    {
                        "name": "Meetings_15_16",
                        "type": "String"
                    },
                    {
                        "name": "Meetings_14_15",
                        "type": "String"
                    },
                    {
                        "name": "Meetings_13_14",
                        "type": "String"
                    },
                    {
                        "name": "Meetings_12_13",
                        "type": "String"
                    },
                    {
                        "name": "Meetings_11_12",
                        "type": "String"
                    },
                    {
                        "name": "Meetings_10_11",
                        "type": "String"
                    },
                    {
                        "name": "Meetings_09_10",
                        "type": "String"
                    },
                    {
                        "name": "Meetings_08_09",
                        "type": "String"
                    },
                    {
                        "name": "Meetings_07_08",
                        "type": "String"
                    },
                    {
                        "name": "Meetings_06_07",
                        "type": "String"
                    },
                    {
                        "name": "Meetings_05_06",
                        "type": "String"
                    },
                    {
                        "name": "Meetings_04_05",
                        "type": "String"
                    },
                    {
                        "name": "Meetings_03_04",
                        "type": "String"
                    },
                    {
                        "name": "Meetings_02_03",
                        "type": "String"
                    },
                    {
                        "name": "Meetings_01_02",
                        "type": "String"
                    },
                    {
                        "name": "Meetings_00_01",
                        "type": "String"
                    },
                    {
                        "name": "LevelDesignation",
                        "type": "String"
                    },
                    {
                        "name": "Organization",
                        "type": "String"
                    },
                    {
                        "name": "TimeZone",
                        "type": "String"
                    },
                    {
                        "name": "IsActive",
                        "type": "String"
                    }
                ]
            },
            "dependsOn": [
                "[concat(variables('factoryId'), '/linkedServices/AzureBlobStorageLS')]"
            ]
        },
        {
            "type": "Microsoft.Storage/storageAccounts",
            "name": "[variables('storageAccName')]",
            "apiVersion": "2016-01-01",
            "location": "[resourceGroup().location]",
            "sku": {
                "name": "[parameters('wpaAppStorageAccType')]"
            },
            "kind": "Storage",
            "resources": [
                {
                    "name": "[concat('default/', parameters('wpaStorageContainerName'))]",
                    "type": "blobServices/containers",
                    "apiVersion": "2018-07-01",
                    "dependsOn": [
                        "[variables('storageAccName')]"
                    ]
                }
            ]
        }
    ],

    "outputs": {
        "ResourceGroupName": {
          "type": "string",
          "value": "[resourceGroup().name]"
        },
        "storageResourceId":{
            "type": "string",
            "value": "[resourceId('Microsoft.Storage/storageAccounts/', variables('storageAccName'))]"
        },
        "storageAccountName": {
          "type": "string",
          "value": "[variables('storageAccName')]"
        },
        "storageAccountLocation": {
          "type": "string",
          "value": "[resourceGroup().location]"
        },
        "storageAccountType": {
          "type": "string",
          "value": "[parameters('wpaAppStorageAccType')]"
        }
      }
}